<dv-gesuch-app-pattern-gesuch-step-layout [step]="GesuchFormSteps.AUSBILDUNG">
  <!-- loading -->
  <div
    data-testid="form-ausbildung-loading"
    *ngIf="view$().loading"
    class="my-2 p-2 py-4 d-flex rounded shadow-sm border"
  >
    <div class="dv-progress-bar-indeterminate">
      <div></div>
    </div>
  </div>

  <!-- form -->
  <form
    [formGroup]="form"
    novalidate
    class="mt-4"
    *ngIf="!view$().loading"
    (ngSubmit)="handleSave()"
  >
    <h3 class="mt-4">
      {{ 'gesuch-app.form.education.place.title' | translate }}
    </h3>

    <!-- LAND -->
    <div class="row">
      <dv-shared-ui-form-field class="col-12 col-md-6 col-xl-4 mt-3">
        <dv-shared-ui-form-label>
          {{ 'gesuch-app.form.education.ausbildungsland.label' | translate }}
        </dv-shared-ui-form-label>
        <select
          class="form-select"
          dvSharedUiFormLabelTarget
          formControlName="ausbildungsland"
          (change)="handleLandChangedByUser()"
        >
          <option [ngValue]="null" selected>
            {{ 'shared.form.select.empty' | translate }}
          </option>
          <option
            [ngValue]="l"
            *ngFor="let l of ausbildungslandValues; trackBy: trackByIndex"
          >
            {{ 'gesuch-app.form.education.ausbildungsland.' + l | translate }}
          </option>
        </select>
        <dv-shared-ui-form-message *dvSharedUiFormMessageError="'required'">
          {{ 'shared.form.error.required' | translate }}
        </dv-shared-ui-form-message>
      </dv-shared-ui-form-field>

      <!-- STAETTE -->
      <dv-shared-ui-form-field class="col-12 col-md-6 col-xl-4 mt-3">
        <dv-shared-ui-form-label>
          {{ 'gesuch-app.form.education.ausbildungstaette.label' | translate }}
        </dv-shared-ui-form-label>

        <!-- Typeahead -->
        <div
          class="position-relative"
          *ngIf="!form.value['ausbildungNichtGefunden']"
        >
          <input
            id="typeahead-focus"
            type="text"
            class="form-control form-select"
            formControlName="ausbildungstaette"
            [ngbTypeahead]="ausbildungstaetteTypeaheadFn$()"
            (focus)="focusAusbildungstaette$.next($any($event).target.value)"
            [editable]="false"
            (change)="handleStaetteChangedByUser()"
            popupClass="dv-typeahead-popup"
            #staetteTypeahead
          />
          <button
            *ngIf="form.controls.ausbildungstaette.value"
            type="button"
            class="btn btn-light dv-typeahead-clear-btn"
            (click)="
              form.controls.ausbildungstaette.setValue('');
              staetteTypeahead.focus();
              handleStaetteChangedByUser()
            "
            [tabIndex]="-1"
          >
            <span class="material-symbols-rounded align-middle">clear</span>
          </button>
        </div>

        <input
          *ngIf="form.value['ausbildungNichtGefunden']"
          class="form-control"
          type="text"
          dvSharedUiFormLabelTarget
          formControlName="alternativeAusbildungstaette"
        />
        <dv-shared-ui-form-message *dvSharedUiFormMessageError="'required'">
          {{ 'shared.form.error.required' | translate }}
        </dv-shared-ui-form-message>
      </dv-shared-ui-form-field>
    </div>

    <!-- GANG -->
    <div class="row">
      <dv-shared-ui-form-field class="col-12 col-md-6 col-xl-4 mt-3">
        <dv-shared-ui-form-label>
          {{ 'gesuch-app.form.education.ausbildungsgang.label' | translate }}
        </dv-shared-ui-form-label>

        <select
          *ngIf="!form.value['ausbildungNichtGefunden']"
          class="form-select"
          dvSharedUiFormLabelTarget
          formControlName="ausbildungsgang"
        >
          <option [ngValue]="null" selected>
            {{ 'shared.form.select.empty' | translate }}
          </option>
          <option
            [value]="l.id"
            *ngFor="let l of ausbildungsgangOptions$(); trackBy: trackByIndex"
          >
            {{ l.bezeichnungDe }}
          </option>
        </select>

        <input
          *ngIf="form.value['ausbildungNichtGefunden']"
          class="form-control"
          type="text"
          dvSharedUiFormLabelTarget
          formControlName="alternativeAusbildungsgang"
        />
        <dv-shared-ui-form-message *dvSharedUiFormMessageError="'required'">
          {{ 'shared.form.error.required' | translate }}
        </dv-shared-ui-form-message>
      </dv-shared-ui-form-field>

      <!-- FACHRICHTUNG -->
      <dv-shared-ui-form-field class="col-12 col-md-6 col-xl-4 mt-3">
        <dv-shared-ui-form-label>
          {{ 'gesuch-app.form.education.fachrichtung.label' | translate }}
        </dv-shared-ui-form-label>
        <input
          class="form-control"
          type="text"
          dvSharedUiFormLabelTarget
          formControlName="fachrichtung"
        />
        <dv-shared-ui-form-message *dvSharedUiFormMessageError="'required'">
          {{ 'shared.form.error.required' | translate }}
        </dv-shared-ui-form-message>
      </dv-shared-ui-form-field>
    </div>

    <!-- MANUELL -->
    <div class="row g-4">
      <dv-shared-ui-form-field class="col-12" [isCheckbox]="true">
        <dv-shared-ui-form-label
          >{{ 'gesuch-app.form.education.manuell.label' | translate }}
        </dv-shared-ui-form-label>
        <div class="form-check">
          <input
            class="form-check-input"
            type="checkbox"
            dvSharedUiFormLabelTarget
            formControlName="ausbildungNichtGefunden"
            (change)="handleManuellChangedByUser()"
          />
        </div>
      </dv-shared-ui-form-field>
    </div>

    <h3 class="mt-4">
      {{ 'gesuch-app.form.education.duration.title' | translate }}
    </h3>

    <div class="row">
      <!-- START -->
      <dv-shared-ui-form-field class="col-12 col-md-6 col-xl-4 mt-3">
        <dv-shared-ui-form-label>{{
          'gesuch-app.form.education.start.label' | translate
        }}</dv-shared-ui-form-label>

        <input
          class="form-control"
          dvSharedUiFormLabelTarget
          formControlName="ausbildungBegin"
          placeholder="MM.YYYY"
          (blur)="onDateBlur(form.controls.ausbildungBegin)"
        />

        <dv-shared-ui-form-message *dvSharedUiFormMessageError="'required'">
          {{ 'shared.form.error.required' | translate }}
        </dv-shared-ui-form-message>
        <dv-shared-ui-form-message *dvSharedUiFormMessageError="'dateFormat'">
          {{ 'shared.form.error.dateFormat' | translate }}
        </dv-shared-ui-form-message>
        <dv-shared-ui-form-message *dvSharedUiFormMessageError="'minDate'">
          {{
            'gesuch-app.form.education.form.error.monthYearNotPast' | translate
          }}
        </dv-shared-ui-form-message>
        <dv-shared-ui-form-message
          *dvSharedUiFormMessageError="'endDateAfterStart'"
        >
          {{
            'gesuch-app.form.education.form.error.monthYearAfterStart'
              | translate
          }}
        </dv-shared-ui-form-message>
        <dv-shared-ui-form-message *dvSharedUiFormMessageError="'maxDate'">
          {{ 'shared.form.error.maxDateFuture' | translate }}
        </dv-shared-ui-form-message>
      </dv-shared-ui-form-field>

      <!-- ENDE -->
      <dv-shared-ui-form-field class="col-12 col-md-6 col-xl-4 mt-3">
        <dv-shared-ui-form-label>{{
          'gesuch-app.form.education.ende.label' | translate
        }}</dv-shared-ui-form-label>

        <input
          class="form-control"
          dvSharedUiFormLabelTarget
          formControlName="ausbildungEnd"
          placeholder="MM.YYYY"
          (blur)="onDateBlur(form.controls.ausbildungEnd)"
        />

        <dv-shared-ui-form-message *dvSharedUiFormMessageError="'required'">
          {{ 'shared.form.error.required' | translate }}
        </dv-shared-ui-form-message>
        <dv-shared-ui-form-message *dvSharedUiFormMessageError="'dateFormat'">
          {{ 'shared.form.error.dateFormat' | translate }}
        </dv-shared-ui-form-message>
        <dv-shared-ui-form-message
          *dvSharedUiFormMessageError="'endDateAfterStart'"
        >
          {{
            'gesuch-app.form.education.form.error.monthYearAfterStart'
              | translate
          }}
        </dv-shared-ui-form-message>
        <dv-shared-ui-form-message *dvSharedUiFormMessageError="'maxDate'">
          {{ 'shared.form.error.maxDateFuture' | translate }}
        </dv-shared-ui-form-message>
      </dv-shared-ui-form-field>
    </div>

    <div class="row">
      <!-- PENSUM -->
      <dv-shared-ui-form-field class="col-12 col-md-6 col-xl-4 mt-3">
        <dv-shared-ui-form-label>
          {{ 'gesuch-app.form.education.pensum.label' | translate }}
        </dv-shared-ui-form-label>

        <select
          class="form-select"
          dvSharedUiFormLabelTarget
          formControlName="pensum"
        >
          <option [ngValue]="null" selected>
            {{ 'shared.form.select.empty' | translate }}
          </option>
          <option
            [ngValue]="l"
            *ngFor="let l of ausbildungspensumValues; trackBy: trackByIndex"
          >
            {{ 'gesuch-app.form.education.pensum.' + l | translate }}
          </option>
        </select>

        <dv-shared-ui-form-message *dvSharedUiFormMessageError="'required'">
          {{ 'shared.form.error.required' | translate }}
        </dv-shared-ui-form-message>
      </dv-shared-ui-form-field>
    </div>

    <!-- Buttons -->
    <dv-gesuch-app-ui-step-form-buttons>
      <button type="submit" class="btn btn-primary">
        {{ 'gesuch-app.form.save-and-continue' | translate }}
      </button>
    </dv-gesuch-app-ui-step-form-buttons>
  </form>
</dv-gesuch-app-pattern-gesuch-step-layout>
