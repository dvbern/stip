@let gesuch = gesuchSig();
@let periode = gesuch.gesuchsperiode;
<div class="tw-@container">
  <div
    class="tw-grid tw-gap-4"
    [ngClass]="{ 'tw-grid-cols-[1fr] @lg:tw-grid-cols-[1fr,auto,1fr]': gesuch.offeneAenderung }"
  >
    <div class="tw-flex tw-flex-col">
      <dl class="tw-flex tw-flex-col tw-mb-10">
        <dt class="tw-font-bold">
          {{ 'gesuch-app.dashboard.gesuch.title' | translate: { yearRange: gesuch.yearRange } }}
        </dt>
        <dd class="tw-mb-6">
          {{ periode.gesuchsperiodeStart | date: 'MM.yyyy' }} - {{ periode.gesuchsperiodeStopp | date: 'MM.yyyy' }}
        </dd>

        <dt class="tw-font-bold">{{ 'gesuch-app.dashboard.gesuch.status.title' | translate }}</dt>
        <dd class="tw-mb-6">
          @if (gesuch.gesuchStatus !== 'IN_BEARBEITUNG_GS' && gesuch.missingDocuments?.count; as count) {
            @if (count > 1) {
              {{ 'gesuch-app.dashboard.periode.status.missingDocuments' | translate: { count } }}
            } @else {
              {{ 'gesuch-app.dashboard.periode.status.missingDocument' | translate }}
            }
          } @else {
            {{ 'shared.gesuch.status.contract.' + gesuch.gesuchStatus | translate }}
          }
        </dd>

        @if (!gesuch.einreichefristAbgelaufen) {
          @if (gesuch.reduzierterBeitrag) {
            <span class="tw-font-bold">
              {{ 'gesuch-app.dashboard.periode.einreichefrist.reduziert' | translate }}
            </span>
          }
          @if ((gesuch.einreichefristDays ?? 0) > 1) {
            <span
              [innerHTML]="
                'gesuch-app.dashboard.periode.einreichefrist.remaining' +
                  (gesuch.reduzierterBeitrag ? '.reduziert' : '') | translate: { days: gesuch.einreichefristDays }
              "
            ></span>
          } @else if (gesuch.einreichefristDays === 1) {
            <span
              [innerHTML]="
                'gesuch-app.dashboard.periode.einreichefrist.1remaining' +
                  (gesuch.reduzierterBeitrag ? '.reduziert' : '') | translate
              "
            ></span>
          } @else {
            <span
              [innerHTML]="
                'gesuch-app.dashboard.periode.einreichefrist.0remaining' +
                  (gesuch.reduzierterBeitrag ? '.reduziert' : '') | translate
              "
            ></span>
          }
          <dt class="tw-font-bold tw-mt-6">
            {{ 'gesuch-app.dashboard.periode.einreichefrist.text' | translate }}
          </dt>
          <dd>
            {{
              (gesuch.reduzierterBeitrag ? periode.einreichefristReduziert : periode.einreichefristNormal)
                | date: 'dd.MM.yyyy'
            }}
          </dd>
        } @else {
          <span class="tw-font-bold">
            {{ 'gesuch-app.dashboard.periode.einreichefrist.abgelaufen.warning' | translate }}
          </span>
          <span class="tw-mt-6">{{ 'gesuch-app.dashboard.periode.einreichefrist.abgelaufen.text' | translate }}</span>
        }
      </dl>
      <div class="tw-flex-grow"></div>
      <div
        class="tw-gap-3"
        [ngClass]="{
          'tw-flex tw-flex-col-reverse': gesuch.offeneAenderung,
          'tw-grid tw-grid-cols-2 xl:tw-grid-cols-3': !gesuch.offeneAenderung,
        }"
      >
        @if (ausbildungsStatusSig() === 'AKTIV') {
          @let trancheId = gesuch.missingDocuments?.trancheId;
          @if (gesuch.canEdit) {
            <a class="btn btn-primary" data-testid="cockpit-gesuch-edit" [routerLink]="['/gesuch', gesuch.id]">
              {{ 'gesuch-app.dashboard.gesuch.edit' | translate }}
            </a>

            @if (gesuch.canDelete) {
              <button
                type="button"
                class="btn btn-outline-primary"
                data-testid="gesuch-app.dashboard.gesuch.delete"
                (click)="deleteGesuch.emit(gesuch.id)"
              >
                <span>{{ 'gesuch-app.dashboard.gesuch.delete' | translate }}</span>
              </button>
            }
          } @else if (trancheId) {
            <a
              class="btn btn-primary"
              data-testid="cockpit-gesuch-upload-missing-documents"
              [routerLink]="['/gesuch', 'dokumente', gesuch.id, 'tranche', trancheId]"
            >
              {{ 'gesuch-app.dashboard.gesuch.uploadMissingDocuments' | translate }}
            </a>
          }
        }
        @if (ausbildungsStatusSig() !== 'AKTIV' || gesuch.gesuchStatus !== 'IN_BEARBEITUNG_GS') {
          <a class="btn btn-outline-primary" data-testid="cockpit-gesuch-edit" [routerLink]="['/gesuch', gesuch.id]">
            {{ 'gesuch-app.dashboard.gesuch.open' | translate }}
          </a>

          @if (
            (gesuch.gesuchStatus === 'IN_FREIGABE' || gesuch.gesuchStatus === 'VERFUEGT') && !gesuch.offeneAenderung
          ) {
            <button
              type="button"
              class="btn btn-outline-primary"
              data-testid="cockpit-gesuch-aenderung-create"
              (click)="aenderungMelden.emit()"
            >
              {{ 'gesuch-app.dashboard.aenderung.create' | translate }}
            </button>
          }
        }
      </div>
    </div>
    @if (gesuch.offeneAenderung) {
      <!-- Vertical Line -->
      <div class="tw-h-full tw-w-full tw-bg-[--dv-light-border-subtle] tw-min-h-[3px] tw-min-w-[3px]"></div>
      <div class="tw-flex tw-flex-col">
        @if (gesuch.offeneAenderung; as aenderung) {
          <div class="divider me-4"></div>
          <dv-gesuch-app-ui-aenderungs-entry
            class="tw-flex tw-flex-col tw-flex-1"
            [tranche]="aenderung"
            [gesuchId]="gesuch.id"
            (deleteAenderung)="deleteAenderung.emit($event)"
          ></dv-gesuch-app-ui-aenderungs-entry>
        }
      </div>
    }
  </div>
</div>
