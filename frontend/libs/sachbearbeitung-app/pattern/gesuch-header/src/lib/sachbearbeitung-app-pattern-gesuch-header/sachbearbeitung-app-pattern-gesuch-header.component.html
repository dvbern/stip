<dv-shared-pattern-app-header
  [backLink]="{
    path: '/',
    text: 'sachbearbeitung-app.header.back' | transloco,
  }"
  (openSidenav)="openSidenav.emit()"
>
  @let gesuchId = gesuchIdSig();
  @let trancheId = gesuchTrancheIdSig();
  <div dvHeaderDesktopLeft class="tw:flex tw:grow tw:items-center tw:gap-4">
    <!-- Gesuch -->
    <button
      type="button"
      class="btn btn-nav fw-normal d-flex align-items-center px-2 shadow-none"
      data-testid="sb-gesuch-header-tranche-nav-menu"
      [class.active]="isTrancheRouteSig()"
      [matMenuTriggerFor]="gesuchMenu"
    >
      <i class="material-symbols-rounded me-2 text-white">checklist</i>
      <span>{{ 'shared.header.tranchenAuswahl' | transloco }}</span>
      <i class="material-symbols-rounded ms-2">expand_more</i>
    </button>
    <mat-menu #gesuchMenu="matMenu" class="header-menu-panel mt-2 rounded">
      <div class="d-flex flex-column gap-2">
        @for (tranche of tranchenSig().list; track $index) {
          <a
            [routerLink]="tranche.url"
            class="btn btn-nav fw-normal d-flex align-items-center px-3 shadow-none"
            data-testid="tranche-nav-menu-item"
            [class.active]="isTrancheRouteSig() && trancheId === tranche.id"
            mat-menu-item
          >
            <span>
              {{
                'shared.header.tranche.item'
                  | transloco: { date: tranche.gueltigAb | date: 'MM.yyyy', index: $index + 1 }
              }}
              -
              {{ tranche.gueltigBis | date: 'MM.yyyy' }}
            </span>
          </a>
        }
      </div>
    </mat-menu>

    <!-- Ã„nderungen -->
    @let aenderungen = gesuchAenderungStore.aenderungenViewSig();
    <button
      type="button"
      class="btn btn-nav fw-normal d-flex align-items-center px-2 shadow-none"
      data-testid="sb-gesuch-header-aenderungen-nav-menu"
      [class.active]="isAenderungRouteSig()"
      [disabled]="!aenderungen.hasAenderungen"
      [matMenuTriggerFor]="aenderungenMenu"
    >
      <i class="material-symbols-rounded me-2 text-white">update</i>
      <span>{{ 'shared.header.aenderungen' | transloco }}</span>
      <i class="material-symbols-rounded ms-2">expand_more</i>
    </button>
    <mat-menu #aenderungenMenu="matMenu" class="header-menu-panel col-12 mt-2 rounded">
      <div class="d-flex flex-column gap-2">
        @for (status of listedAenderungen; track $index) {
          @if (aenderungen.byStatus[status].length) {
            @if (!$first) {
              <div class="d-flex align-items-center text-muted small gap-2">
                <hr class="flex-grow-1" />
                {{ 'shared.header.aenderungen.' + status | transloco }}
                <hr class="flex-grow-1" />
              </div>
            }
            @for (aenderung of aenderungen.byStatus[status]; track $index) {
              <a
                [routerLink]="['/', 'gesuch', gesuchId, aenderung.route, aenderung.id]"
                [queryParams]="{ revision: aenderung.revision }"
                class="btn btn-nav fw-normal d-flex align-items-center px-3 shadow-none"
                data-testid="aenderungen-nav-menu-item"
                mat-menu-item
                [class.active]="trancheId === aenderung.id && revisionSig() === aenderung.revision"
              >
                <span>
                  {{
                    aenderung.typ === 'TRANCHE'
                      ? ('shared.header.tranche.item'
                        | transloco: { date: aenderung.gueltigAb | date: 'dd.MM.yyyy', index: aenderung.index + 1 })
                      : ('shared.header.aenderung.item'
                        | transloco: { date: aenderung.gueltigAb | date: 'dd.MM.yyyy', index: aenderung.index + 1 })
                  }}
                  -
                  {{ aenderung.gueltigBis | date: 'dd.MM.yyyy' }}
                </span>
              </a>
            }
          }
        }
      </div>
    </mat-menu>

    <!-- Verfuegung-->
    <a
      [routerLink]="['/', 'verfuegung', gesuchId]"
      routerLinkActive="active"
      class="btn btn-nav fw-normal d-flex align-items-center px-2 shadow-none"
      data-testid="sb-gesuch-header-verfuegung-link"
      [class.disabled]="!canViewBerechnungSig()"
    >
      <i class="material-symbols-rounded me-2 text-white">equal</i>
      <span>{{ 'sachbearbeitung-app.header.verfuegung' | transloco }}</span>
    </a>

    <!-- Infos-->
    <a
      [routerLink]="['/', 'infos', gesuchId]"
      class="btn btn-nav fw-normal d-flex align-items-center px-2 shadow-none"
      data-testid="sb-gesuch-header-infos-link"
      [class.active]="isInfosRouteSig()"
    >
      <i class="material-symbols-rounded me-2 text-white">info</i>
      <span>{{ 'sachbearbeitung-app.header.infos' | transloco }}</span>
    </a>

    @let statusUebergaenge = statusUebergaengeOptionsSig();
    @let availableTrancheInteraction = availableTrancheInteractionSig();

    <div class="text-body-tertiary vr my-1"></div>

    <!-- Darlehen Menu -->
    @let view = darlehenStore.darlehenListSbViewSig();
    <dv-shared-ui-darlehen-menu
      [darlehenListSig]="view.list"
      [canCreateDarlehenSig]="false"
      [idTypeSig]="['gesuch', gesuchId]"
    ></dv-shared-ui-darlehen-menu>

    @if (isTrancheRouteSig()) {
      <!-- Separator -->

      <div class="tw:relative">
        @if (isLoadingSig()) {
          <dv-shared-ui-loading class="tw:absolute tw:inset-0" [type]="'icon'"></dv-shared-ui-loading>
        }
        <!-- Aktion Button -->
        <button
          type="button"
          class="btn btn-outline-primary fw-normal d-flex align-items-center px-3 shadow-none"
          data-testid="sb-gesuch-header-aktion-menu"
          [class.active]="aktionTrigger.menuOpen"
          [disabled]="!(statusUebergaenge.isNotEmpty || availableTrancheInteraction) || isLoadingSig()"
          #aktionTrigger="matMenuTrigger"
          [matMenuTriggerFor]="aktionMenu"
        >
          <i class="material-symbols-rounded me-3">sync_alt</i>
          <span>{{ 'sachbearbeitung-app.header.aktion' | transloco }}</span>
          <i class="material-symbols-rounded ms-2">expand_more</i>
        </button>
        <!-- Aktion Menu -->
        <mat-menu #aktionMenu="matMenu" class="header-menu-panel mt-2 rounded">
          <div class="d-flex flex-column gap-2">
            @switch (availableTrancheInteraction) {
              @case ('CREATE_TRANCHE') {
                <!-- Tranche erstellen -->
                <button
                  type="button"
                  class="btn fw-normal px-2 shadow-none"
                  data-testid="aktion-tranche-erstellen"
                  mat-menu-item
                  (click)="createTranche()"
                >
                  <div class="d-flex align-items-center gap-2">
                    <i class="material-symbols-rounded">add_circle</i>
                    <span>{{ 'sachbearbeitung-app.header.tranche.erstellen' | transloco }}</span>
                  </div>
                </button>
              }
            }

            @if (statusUebergaenge.isNotEmpty && availableTrancheInteraction) {
              <hr class="my-1" />
            }

            @for (uebergang of statusUebergaenge.list; track $index) {
              <button
                type="button"
                class="btn fw-normal pe-auto px-2 shadow-none"
                [attr.data-testid]="'sb-gesuch-header-aktion-status-uebergang-' + uebergang.typ"
                [disabled]="uebergang.disabledReason || !trancheId"
                [matTooltip]="
                  uebergang.disabledReason
                    ? ('sachbearbeitung-app.header.status-uebergang.disabled-reason.' + uebergang.disabledReason
                      | transloco)
                    : null
                "
                mat-menu-item
                (click)="setStatusUebergang(uebergang.typ, gesuchId, trancheId)"
              >
                <div class="d-flex align-items-center gap-2">
                  <i class="material-symbols-rounded">{{ uebergang.icon }}</i>
                  <span>{{ 'sachbearbeitung-app.header.status-uebergang.' + uebergang.titleKey | transloco }}</span>
                </div>
              </button>
            }
          </div>
        </mat-menu>
      </div>
    }
    @if (isBeschwerdeHaengigSig()) {
      <div class="tw:w-full tw:grow"></div>

      <div class="tw:text-sm">
        <mat-chip [color]="'info'" highlighted>
          {{ 'sachbearbeitung-app.infos.beschwerde.haengig.title' | transloco }}
        </mat-chip>
      </div>
    }
  </div>
</dv-shared-pattern-app-header>
