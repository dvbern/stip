@let view = viewSig();
@let gesuchTrancheId = view.gesuch?.gesuchTrancheToWorkWith?.id;
@if (view.loading) {
  <dv-shared-ui-loading data-testid="form-eltern-steuerdaten-loading"></dv-shared-ui-loading>
} @else {
  @if (gesuchTrancheId) {
    <div class="row g-4 my-2" *dvHasRoles="['V0_Sachbearbeiter']">
      <div class="col-12 col-md-6 col-xl-4">
        <button
          class="btn btn-primary"
          type="button"
          (click)="updateSteuerdatenFromNesko(gesuchTrancheId)"
          [disabled]="!canCheckNeskoSig()"
          data-testid="button-update-from-nesko"
        >
          {{ 'sachbearbeitung-app.gesuch.steuerdaten.updateFromNesko' | transloco }}
        </button>
      </div>
    </div>
  }

  <form
    [formGroup]="form"
    novalidate
    class="mt-4"
    data-testid="form-eltern-steuerdaten-form"
    [dvSharedUiFormReadonly]="view.readonly"
    (gotReenabledSig)="gotReenabled$.next({})"
  >
    <h3 class="pt-5">
      {{ 'shared.form.shared.section.einnahmen' | transloco }}
    </h3>

    <div class="row g-4 my-2">
      <!-- Total Einkünfte-->
      <mat-form-field dvSharedUiFormField class="col-12 col-md-6 col-xl-4">
        <mat-label>{{ 'shared.form.eltern-steuerdaten.totalEinkuenfte.label' | transloco }}</mat-label>
        <input
          formControlName="totalEinkuenfte"
          data-testid="form-eltern-steuerdaten.totalEinkuenfte"
          matInput
          [maskito]="maskitoNumber"
          type="text"
        />
        <mat-error *dvSharedUiFormMessageError="'required'">
          {{ 'shared.form.error.required' | transloco }}
        </mat-error>
      </mat-form-field>

      <!-- Eigenmietwert-->
      <mat-form-field dvSharedUiFormField class="col-12 col-md-6 col-xl-4">
        <mat-label>{{ 'shared.form.eltern-steuerdaten.eigenmietwert.label' | transloco }}</mat-label>
        <input
          formControlName="eigenmietwert"
          data-testid="form-eltern-steuerdaten.eigenmietwert"
          matInput
          [maskito]="maskitoNumber"
          type="text"
        />
        <mat-error *dvSharedUiFormMessageError="'required'">
          {{ 'shared.form.error.required' | transloco }}
        </mat-error>
      </mat-form-field>
    </div>

    <div class="row mt-1">
      <!-- Arbeitsverhaeltnis-->
      <mat-radio-group
        class="col-12"
        formControlName="arbeitsverhaeltnis"
        data-testid="form-eltern-steuerdaten-arbeitsverhaeltnis"
        dvSharedUiFormField
      >
        <mat-label>{{ 'shared.form.eltern-steuerdaten.arbeitsverhaeltnis.label' | transloco }}</mat-label>
        <div class="d-flex gap-2 col-12 col-md-6 col-xl-4 pe-md-3">
          <div class="d-flex flex-column">
            <mat-radio-button data-testid="selbstaendig" [value]="true">{{
              'shared.form.eltern-steuerdaten.arbeitsverhaeltnis.true' | transloco
            }}</mat-radio-button>
            <mat-radio-button data-testid="unselbstaendig" [value]="false">{{
              'shared.form.eltern-steuerdaten.arbeitsverhaeltnis.false' | transloco
            }}</mat-radio-button>
          </div>
        </div>
        <div class="group-errors">
          <mat-error *dvSharedUiFormMessageError="'required'">
            {{ 'shared.form.error.required' | transloco }}
          </mat-error>
        </div>
      </mat-radio-group>
    </div>

    @if (
      !hiddenFieldSet.valuesSig().has(form.controls.saeule3a) || !hiddenFieldSet.valuesSig().has(form.controls.saeule2)
    ) {
      <div class="row g-4 my-2">
        <!-- Saeule 3a-->
        @if (!hiddenFieldSet.valuesSig().has(form.controls.saeule3a)) {
          <mat-form-field dvSharedUiFormField class="col-12 col-md-6 col-xl-4">
            <mat-label>{{ 'shared.form.eltern-steuerdaten.saeule3a.label' | transloco }}</mat-label>
            <input
              formControlName="saeule3a"
              data-testid="form-eltern-steuerdaten.saeule3a"
              matInput
              [maskito]="maskitoNumber"
              type="text"
            />
            <mat-error *dvSharedUiFormMessageError="'required'">
              {{ 'shared.form.error.required' | transloco }}
            </mat-error>
          </mat-form-field>
        }
        <!-- Saeule 2-->
        @if (!hiddenFieldSet.valuesSig().has(form.controls.saeule2)) {
          <mat-form-field dvSharedUiFormField class="col-12 col-md-6 col-xl-4">
            <mat-label>{{ 'shared.form.eltern-steuerdaten.saeule2.label' | transloco }}</mat-label>
            <input
              formControlName="saeule2"
              data-testid="form-eltern-steuerdaten.saeule2"
              matInput
              [maskito]="maskitoNumber"
              type="text"
            />
            <mat-error *dvSharedUiFormMessageError="'required'">
              {{ 'shared.form.error.required' | transloco }}
            </mat-error>
          </mat-form-field>
        }
      </div>
    }

    <div class="row g-4 my-2">
      <!-- Kinderalimente-->
      <mat-form-field dvSharedUiFormField class="col-12 col-md-6 col-xl-4">
        <mat-label>{{ 'shared.form.eltern-steuerdaten.kinderalimente.label' | transloco }}</mat-label>
        <input
          formControlName="kinderalimente"
          data-testid="form-eltern-steuerdaten.kinderalimente"
          matInput
          [maskito]="maskitoNumber"
          type="text"
        />
        <mat-error *dvSharedUiFormMessageError="'required'">
          {{ 'shared.form.error.required' | transloco }}
        </mat-error>
      </mat-form-field>
      <!-- Vermögen-->
      <mat-form-field dvSharedUiFormField class="col-12 col-md-6 col-xl-4">
        <mat-label>{{ 'shared.form.eltern-steuerdaten.vermoegen.label' | transloco }}</mat-label>
        <input
          formControlName="vermoegen"
          data-testid="form-eltern-steuerdaten.vermoegen"
          matInput
          [maskito]="maskitoNumber"
          type="text"
        />
        <mat-error *dvSharedUiFormMessageError="'required'">
          {{ 'shared.form.error.required' | transloco }}
        </mat-error>
      </mat-form-field>
    </div>

    <h3 class="pt-5">
      {{ 'shared.form.shared.section.ausgaben' | transloco }}
    </h3>

    <div class="row g-4 my-2">
      <!-- Steuern Kanton-Gemeinde-->
      <mat-form-field dvSharedUiFormField class="col-12 col-md-6 col-xl-4">
        <mat-label>{{ 'shared.form.eltern-steuerdaten.steuernKantonGemeinde.label' | transloco }}</mat-label>
        <input
          formControlName="steuernKantonGemeinde"
          data-testid="form-eltern-steuerdaten.steuernKantonGemeinde"
          matInput
          [maskito]="maskitoNumber"
          type="text"
        />
        <mat-error *dvSharedUiFormMessageError="'required'">
          {{ 'shared.form.error.required' | transloco }}
        </mat-error>
      </mat-form-field>

      <!-- Steuern Bund-->
      <mat-form-field dvSharedUiFormField class="col-12 col-md-6 col-xl-4">
        <mat-label>{{ 'shared.form.eltern-steuerdaten.steuernBund.label' | transloco }}</mat-label>
        <input
          formControlName="steuernBund"
          data-testid="form-eltern-steuerdaten.steuernBund"
          matInput
          [maskito]="maskitoNumber"
          type="text"
        />
        <mat-error *dvSharedUiFormMessageError="'required'">
          {{ 'shared.form.error.required' | transloco }}
        </mat-error>
      </mat-form-field>
    </div>

    <div class="row g-4 my-2">
      <!-- Fahrkosten-->
      <mat-form-field dvSharedUiFormField class="col-12 col-md-6 col-xl-4">
        <mat-label>{{ 'shared.form.eltern-steuerdaten.fahrkosten.label' | transloco }}</mat-label>
        <input
          formControlName="fahrkosten"
          data-testid="form-eltern-steuerdaten.fahrkosten"
          matInput
          [maskito]="maskitoNumber"
          type="text"
        />
        <mat-error *dvSharedUiFormMessageError="'required'">
          {{ 'shared.form.error.required' | transloco }}
        </mat-error>
      </mat-form-field>

      <!-- Fahrkosten Partner:in-->
      <mat-form-field dvSharedUiFormField class="col-12 col-md-6 col-xl-4">
        <mat-label>{{ 'shared.form.eltern-steuerdaten.fahrkostenPartner.label' | transloco }}</mat-label>
        <input
          formControlName="fahrkostenPartner"
          data-testid="form-eltern-steuerdaten.fahrkostenPartner"
          matInput
          [maskito]="maskitoNumber"
          type="text"
        />
      </mat-form-field>
    </div>

    <div class="row g-4 my-2">
      <!-- Verpflegung-->
      <mat-form-field dvSharedUiFormField class="col-12 col-md-6 col-xl-4">
        <mat-label>{{ 'shared.form.eltern-steuerdaten.verpflegung.label' | transloco }}</mat-label>
        <input
          formControlName="verpflegung"
          data-testid="form-eltern-steuerdaten.verpflegung"
          matInput
          [maskito]="maskitoNumber"
          type="text"
        />
        <mat-error *dvSharedUiFormMessageError="'required'">
          {{ 'shared.form.error.required' | transloco }}
        </mat-error>
      </mat-form-field>

      <!-- Verpflegung Partner:in-->
      <mat-form-field dvSharedUiFormField class="col-12 col-md-6 col-xl-4">
        <mat-label>{{ 'shared.form.eltern-steuerdaten.verpflegungPartner.label' | transloco }}</mat-label>
        <input
          formControlName="verpflegungPartner"
          data-testid="form-eltern-steuerdaten.verpflegungPartner"
          matInput
          [maskito]="maskitoNumber"
          type="text"
        />
      </mat-form-field>
    </div>

    <div class="row g-4 my-2">
      <!-- Steuerjahr-->
      @if (!hiddenFieldSet.valuesSig().has(form.controls.steuerjahr)) {
        <mat-form-field dvSharedUiFormField class="col-12 col-md-6 col-xl-4">
          <mat-label>{{ 'shared.form.eltern-steuerdaten.steuerjahr.label' | transloco }}</mat-label>
          <input
            formControlName="steuerjahr"
            data-testid="form-eltern-steuerdaten.steuerjahr"
            matInput
            min="1900"
            [max]="steuerjahrValidation.steuerjahrPeriodeSig()"
            type="number"
          />
          <mat-error *dvSharedUiFormMessageError="'required'">
            {{ 'shared.form.error.required' | transloco }}
          </mat-error>
          <mat-error *dvSharedUiFormMessageError="'range'">
            {{ 'shared.form.error.range' | transloco: { min: 1900, max: steuerjahrValidation.steuerjahrPeriodeSig() } }}
          </mat-error>
        </mat-form-field>
      }
      <!-- veranlagungsStatus-->
      @if (!hiddenFieldSet.valuesSig().has(form.controls.veranlagungsStatus)) {
        <mat-form-field dvSharedUiFormField class="col-12 col-md-6 col-xl-4">
          <mat-label>{{ 'shared.form.eltern-steuerdaten.veranlagungsStatus.label' | transloco }}</mat-label>
          <input
            formControlName="veranlagungsStatus"
            data-testid="form-eltern-steuerdaten.veranlagungsStatus"
            matInput
            type="number"
            min="0"
            max="99"
          />
          <mat-error *dvSharedUiFormMessageError="'required'">
            {{ 'shared.form.error.required' | transloco }}
          </mat-error>
          <mat-error *dvSharedUiFormMessageError="'range'">
            {{ 'shared.form.error.range' | transloco: { min: 0, max: 99 } }}
          </mat-error>
        </mat-form-field>
      }
    </div>

    <dv-shared-ui-step-form-buttons>
      @if (!view.readonly) {
        <button type="submit" (click)="handleSave()" class="btn btn-primary" data-testid="button-save-continue">
          {{ 'shared.form.save-and-continue' | transloco }}
        </button>
      } @else {
        <button type="button" data-testid="button-next" class="btn btn-primary" (click)="handleContinue()">
          {{ 'shared.form.gonext' | transloco }}
        </button>
      }
    </dv-shared-ui-step-form-buttons>
  </form>
}
