@if (viewSig().loading) {
  <dv-shared-ui-loading data-testid="form-family-loading"></dv-shared-ui-loading>
} @else {
  <form [formGroup]="form" data-testid="form-family-form" novalidate class="mt-4" (ngSubmit)="handleSave()">
    <div class="col-12 col-xl-6 col-md-9">
      <dv-shared-ui-stepper-navigation
        [nextStepVisible]="hasNextStep()"
        [prevStepVisible]="hasPreviousStep()"
        (nextStep)="goNextStep()"
        (prevStep)="goPreviousStep()"
      ></dv-shared-ui-stepper-navigation>
      <div class="questions-wrapper">
        <div
          class="row g-4 mt-3"
          (@inOutPaneAnimation.start)="duringAnimation = 'hide'"
          (@inOutPaneAnimation.done)="duringAnimation = 'show'"
          [@inOutPaneAnimation]="stateSig()['ELTERN_VERHEIRATET_ZUSAMMEN'] ?? 'hidden'"
        >
          <mat-radio-group
            formControlName="elternVerheiratetZusammen"
            data-testid="form-family-elternVerheiratetZusammen"
            dvSharedUiFormField
            class="d-flex flex-column"
          >
            <label>{{
              'shared.form.familiensituation.leibliche-eltern-verheiratet-konkubinat.label' | translate
            }}</label>

            <mat-radio-button data-testid="yes" [value]="true">{{
              'shared.form.radio.yes' | translate
            }}</mat-radio-button>

            <mat-radio-button data-testid="no" [value]="false">{{
              'shared.form.radio.no' | translate
            }}</mat-radio-button>

            <mat-error *dvSharedUiFormMessageError="'required'">
              {{ 'shared.form.error.required' | translate }}
            </mat-error>
          </mat-radio-group>
        </div>

        <div
          (@inOutPaneAnimation.start)="duringAnimation = 'hide'"
          (@inOutPaneAnimation.done)="duringAnimation = 'show'"
          [@inOutPaneAnimation]="stateSig()['ALIMENTENREGELUNG'] ?? 'hidden'"
        >
          <div class="row g-4 mt-3">
            <mat-radio-group
              formControlName="gerichtlicheAlimentenregelung"
              data-testid="form-family-gerichtlicheAlimentenregelung"
              class="col-12"
            >
              <label>{{ 'shared.form.familiensituation.gerichtliche-alimentenregelung.label' | translate }}</label>
              <div class="d-flex gap-2 flex-wrap justify-content-between">
                <div class="d-flex flex-column">
                  <mat-radio-button data-testid="yes" [value]="true">{{
                    'shared.form.radio.yes' | translate
                  }}</mat-radio-button>

                  <mat-radio-button data-testid="no" [value]="false">{{
                    'shared.form.radio.no' | translate
                  }}</mat-radio-button>
                </div>

                @if (trennungsvereinbarungDocumentSig(); as options) {
                  <dv-shared-pattern-document-upload
                    class="flex-shrink-1 mt-2"
                    [optionsSig]="options"
                  ></dv-shared-pattern-document-upload>
                }
              </div>
              <mat-error *dvSharedUiFormMessageError="'required'">
                {{ 'shared.form.error.required' | translate }}
              </mat-error>
            </mat-radio-group>
          </div>
          @if (!hiddenFieldsSetSig().has(form.controls.werZahltAlimente)) {
            <div class="row g-4 mt-3">
              <mat-form-field dvSharedUiFormField>
                <mat-label>{{ 'shared.form.familiensituation.wer-zahlt-alimente.label' | translate }}</mat-label>
                <mat-select formControlName="werZahltAlimente" data-testid="form-family-werZahltAlimente">
                  <mat-option [value]="null" disabled selected>
                    {{ 'shared.form.select.empty' | translate }}
                  </mat-option>
                  <mat-option [value]="ELTERNSCHAFTSTEILUNG.VATER" [attr.data-testid]="ELTERNSCHAFTSTEILUNG.VATER">
                    {{ 'shared.form.familiensituation.vater' | translate }}
                  </mat-option>
                  <mat-option [value]="ELTERNSCHAFTSTEILUNG.MUTTER" [attr.data-testid]="ELTERNSCHAFTSTEILUNG.MUTTER">
                    {{ 'shared.form.familiensituation.mutter' | translate }}
                  </mat-option>
                  <mat-option
                    [value]="ELTERNSCHAFTSTEILUNG.GEMEINSAM"
                    [attr.data-testid]="ELTERNSCHAFTSTEILUNG.GEMEINSAM"
                  >
                    {{ 'shared.form.familiensituation.gemeinsam' | translate }}
                  </mat-option>
                </mat-select>

                <mat-error *dvSharedUiFormMessageError="'required'">
                  {{ 'shared.form.error.required' | translate }}
                </mat-error>
              </mat-form-field>
            </div>
          }
          @if (
            !hiddenFieldsSetSig().has(form.controls.mutterWiederverheiratet) && form.value.gerichtlicheAlimentenregelung
          ) {
            <ng-container [ngTemplateOutlet]="mutterWiederverheiratet"></ng-container>
          }
          @if (
            !hiddenFieldsSetSig().has(form.controls.vaterWiederverheiratet) && form.value.gerichtlicheAlimentenregelung
          ) {
            <ng-container [ngTemplateOutlet]="vaterWiederverheiratet"></ng-container>
          }
        </div>
        <div
          (@inOutPaneAnimation.start)="duringAnimation = 'hide'"
          (@inOutPaneAnimation.done)="duringAnimation = 'show'"
          [@inOutPaneAnimation]="stateSig()['ELTERN_UNBEKANNT_VERSTORBEN'] ?? 'hidden'"
        >
          <div class="row g-4 mt-3">
            <mat-radio-group
              formControlName="elternteilUnbekanntVerstorben"
              data-testid="form-family-elternteilUnbekanntVerstorben"
              dvSharedUiFormField
              class="d-flex flex-column"
            >
              <label>{{ 'shared.form.familiensituation.elternteil-verstorben-unbekannt.label' | translate }}</label>
              <mat-radio-button data-testid="yes" [value]="true">{{
                'shared.form.radio.yes' | translate
              }}</mat-radio-button>

              <mat-radio-button data-testid="no" [value]="false">{{
                'shared.form.radio.no' | translate
              }}</mat-radio-button>

              <mat-error *dvSharedUiFormMessageError="'required'">
                {{ 'shared.form.error.required' | translate }}
              </mat-error>
            </mat-radio-group>
          </div>
          @if (!hiddenFieldsSetSig().has(form.controls.mutterUnbekanntVerstorben)) {
            <div class="row g-4 mt-3">
              <span>{{ 'shared.form.familiensituation.elternteil-verstorben.label' | translate }}</span>
              <mat-radio-group
                formControlName="mutterUnbekanntVerstorben"
                data-testid="form-family-mutterUnbekanntVerstorben"
                dvSharedUiFormField
                class="d-flex flex-column"
              >
                <label>{{ 'shared.form.familiensituation.mutter' | translate }}</label>

                <mat-radio-button
                  [attr.data-testid]="ELTERN_ABWESENHEITS_GRUND.VERSTORBEN"
                  [value]="ELTERN_ABWESENHEITS_GRUND.VERSTORBEN"
                  >{{
                    'shared.form.familiensituation.elternteil-verstorben-unbekannt.verstorben' | translate
                  }}</mat-radio-button
                >

                <mat-radio-button
                  [attr.data-testid]="ELTERN_ABWESENHEITS_GRUND.UNBEKANNT"
                  [value]="ELTERN_ABWESENHEITS_GRUND.UNBEKANNT"
                  >{{
                    'shared.form.familiensituation.elternteil-verstorben-unbekannt.unbekannt' | translate
                  }}</mat-radio-button
                >

                <mat-radio-button
                  [attr.data-testid]="ELTERN_ABWESENHEITS_GRUND.WEDER_NOCH"
                  [value]="ELTERN_ABWESENHEITS_GRUND.WEDER_NOCH"
                  >{{
                    'shared.form.familiensituation.elternteil-verstorben-unbekannt.keine' | translate
                  }}</mat-radio-button
                >

                <mat-error *dvSharedUiFormMessageError="'required'">
                  {{ 'shared.form.error.required' | translate }}
                </mat-error>
              </mat-radio-group>
            </div>
          }
          @if (!hiddenFieldsSetSig().has(form.controls.mutterUnbekanntGrund)) {
            <div class="row g-4 mt-3 flex-nowrap">
              <mat-radio-group
                formControlName="mutterUnbekanntGrund"
                data-testid="form-family-mutterUnbekanntGrund"
                dvSharedUiFormField
                class="d-flex flex-column"
              >
                <label>{{ 'shared.form.familiensituation.mutter-unbekannt-reason.label' | translate }}</label>
                <div class="d-flex gap-2 flex-wrap justify-content-between">
                  <div class="d-flex flex-column">
                    <mat-radio-button
                      [attr.data-testid]="ELTERN_UNBEKANNTHEITS_GRUND.UNBEKANNTER_AUFENTHALTSORT"
                      [value]="ELTERN_UNBEKANNTHEITS_GRUND.UNBEKANNTER_AUFENTHALTSORT"
                      >{{
                        'shared.form.familiensituation.elternteil-unbekannt-reason.unbekannter-aufenthaltsort'
                          | translate
                      }}</mat-radio-button
                    >
                    <mat-radio-button
                      [attr.data-testid]="ELTERN_UNBEKANNTHEITS_GRUND.FEHLENDE_ANERKENNUNG"
                      [value]="ELTERN_UNBEKANNTHEITS_GRUND.FEHLENDE_ANERKENNUNG"
                      >{{
                        'shared.form.familiensituation.elternteil-unbekannt-reason.fehlende-mutterschaftsanerkennung'
                          | translate
                      }}</mat-radio-button
                    >
                  </div>
                  @if (mutterUnbekanntDocumentSig(); as options) {
                    <dv-shared-pattern-document-upload
                      class="flex-shrink-1 mt-2"
                      [optionsSig]="options"
                    ></dv-shared-pattern-document-upload>
                  }
                </div>
                <mat-error *dvSharedUiFormMessageError="'required'">
                  {{ 'shared.form.error.required' | translate }}
                </mat-error>
              </mat-radio-group>
            </div>
          }
          @if (
            !hiddenFieldsSetSig().has(form.controls.mutterWiederverheiratet) && form.value.elternteilUnbekanntVerstorben
          ) {
            <ng-container [ngTemplateOutlet]="mutterWiederverheiratet"></ng-container>
          }
          @if (!hiddenFieldsSetSig().has(form.controls.vaterUnbekanntVerstorben)) {
            <div class="row g-4 mt-3">
              <mat-radio-group
                formControlName="vaterUnbekanntVerstorben"
                data-testid="form-family-vaterUnbekanntVerstorben"
                dvSharedUiFormField
                class="d-flex flex-column"
              >
                <label>{{ 'shared.form.familiensituation.vater' | translate }}</label>

                <mat-radio-button
                  [attr.data-testid]="ELTERN_ABWESENHEITS_GRUND.VERSTORBEN"
                  [value]="ELTERN_ABWESENHEITS_GRUND.VERSTORBEN"
                  >{{
                    'shared.form.familiensituation.elternteil-verstorben-unbekannt.verstorben' | translate
                  }}</mat-radio-button
                >

                <mat-radio-button
                  [attr.data-testid]="ELTERN_ABWESENHEITS_GRUND.UNBEKANNT"
                  [value]="ELTERN_ABWESENHEITS_GRUND.UNBEKANNT"
                  >{{
                    'shared.form.familiensituation.elternteil-verstorben-unbekannt.unbekannt' | translate
                  }}</mat-radio-button
                >

                <mat-radio-button
                  [attr.data-testid]="ELTERN_ABWESENHEITS_GRUND.WEDER_NOCH"
                  [value]="ELTERN_ABWESENHEITS_GRUND.WEDER_NOCH"
                  >{{
                    'shared.form.familiensituation.elternteil-verstorben-unbekannt.keine' | translate
                  }}</mat-radio-button
                >

                <mat-error *dvSharedUiFormMessageError="'required'">
                  {{ 'shared.form.error.required' | translate }}
                </mat-error>
              </mat-radio-group>
            </div>
          }
          @if (!hiddenFieldsSetSig().has(this.form.controls.vaterUnbekanntGrund)) {
            <div class="row g-4 mt-3">
              <mat-radio-group
                formControlName="vaterUnbekanntGrund"
                data-testid="form-family-vaterUnbekanntGrund"
                dvSharedUiFormField
                class="col-12"
              >
                <label>{{ 'shared.form.familiensituation.vater-unbekannt-reason.label' | translate }}</label>
                <div class="d-flex gap-2 flex-wrap justify-content-between">
                  <div class="d-flex flex-column">
                    <mat-radio-button
                      [attr.data-testid]="ELTERN_UNBEKANNTHEITS_GRUND.UNBEKANNTER_AUFENTHALTSORT"
                      [value]="ELTERN_UNBEKANNTHEITS_GRUND.UNBEKANNTER_AUFENTHALTSORT"
                      >{{
                        'shared.form.familiensituation.elternteil-unbekannt-reason.unbekannter-aufenthaltsort'
                          | translate
                      }}</mat-radio-button
                    >
                    <mat-radio-button
                      [attr.data-testid]="ELTERN_UNBEKANNTHEITS_GRUND.FEHLENDE_ANERKENNUNG"
                      [value]="ELTERN_UNBEKANNTHEITS_GRUND.FEHLENDE_ANERKENNUNG"
                      >{{
                        'shared.form.familiensituation.elternteil-unbekannt-reason.fehlende-vaterschaftsanerkennung'
                          | translate
                      }}</mat-radio-button
                    >
                  </div>
                  @if (vaterUnbekanntDocumentSig(); as options) {
                    <dv-shared-pattern-document-upload
                      class="flex-shrink-1 mt-2"
                      [optionsSig]="options"
                    ></dv-shared-pattern-document-upload>
                  }
                </div>

                <mat-error *dvSharedUiFormMessageError="'required'">
                  {{ 'shared.form.error.required' | translate }}
                </mat-error>
              </mat-radio-group>
            </div>
          }
          @if (
            !hiddenFieldsSetSig().has(this.form.controls.vaterWiederverheiratet) &&
            form.value.elternteilUnbekanntVerstorben
          ) {
            <ng-container [ngTemplateOutlet]="vaterWiederverheiratet"></ng-container>
          }
        </div>

        <div
          (@inOutPaneAnimation.start)="duringAnimation = 'hide'"
          (@inOutPaneAnimation.done)="duringAnimation = 'show'"
          [@inOutPaneAnimation]="stateSig()['ZWEI_FAMILIENBUDGET'] ?? 'hidden'"
        >
          @if (!hiddenFieldsSetSig().has(form.controls.mutterWiederverheiratet)) {
            <ng-container [ngTemplateOutlet]="mutterWiederverheiratet"></ng-container>
          }
          @if (!hiddenFieldsSetSig().has(form.controls.vaterWiederverheiratet)) {
            <ng-container [ngTemplateOutlet]="vaterWiederverheiratet"></ng-container>
          }
          <div class="row g-4 mt-3 col-xl-8">
            <mat-form-field dvSharedUiFormField>
              <mat-label>{{ 'shared.form.familiensituation.sorgerecht.label' | translate }}</mat-label>
              <mat-select formControlName="sorgerecht" data-testid="form-family-sorgerecht">
                <mat-option [value]="null" disabled selected>
                  {{ 'shared.form.select.empty' | translate }}
                </mat-option>
                <mat-option [value]="ELTERNSCHAFTSTEILUNG.VATER" [attr.data-testid]="ELTERNSCHAFTSTEILUNG.VATER">
                  {{ 'shared.form.familiensituation.vater' | translate }}
                </mat-option>
                <mat-option [value]="ELTERNSCHAFTSTEILUNG.MUTTER" [attr.data-testid]="ELTERNSCHAFTSTEILUNG.MUTTER">
                  {{ 'shared.form.familiensituation.mutter' | translate }}
                </mat-option>
                <mat-option
                  [value]="ELTERNSCHAFTSTEILUNG.GEMEINSAM"
                  [attr.data-testid]="ELTERNSCHAFTSTEILUNG.GEMEINSAM"
                >
                  {{ 'shared.form.familiensituation.gemeinsam' | translate }}
                </mat-option>
              </mat-select>

              <mat-error *dvSharedUiFormMessageError="'required'">
                {{ 'shared.form.error.required' | translate }}
              </mat-error>
            </mat-form-field>
          </div>

          <div class="row g-4 mt-3 col-xl-8">
            <mat-form-field dvSharedUiFormField>
              <mat-label>{{ 'shared.form.familiensituation.obhut.label' | translate }}</mat-label>
              <mat-select formControlName="obhut" data-testid="form-family-obhut">
                <mat-option [value]="null" disabled selected>
                  {{ 'shared.form.select.empty' | translate }}
                </mat-option>
                <mat-option [value]="ELTERNSCHAFTSTEILUNG.VATER" [attr.data-testid]="ELTERNSCHAFTSTEILUNG.VATER">
                  {{ 'shared.form.familiensituation.vater' | translate }}
                </mat-option>
                <mat-option [value]="ELTERNSCHAFTSTEILUNG.MUTTER" [attr.data-testid]="ELTERNSCHAFTSTEILUNG.MUTTER">
                  {{ 'shared.form.familiensituation.mutter' | translate }}
                </mat-option>
                <mat-option
                  [value]="ELTERNSCHAFTSTEILUNG.GEMEINSAM"
                  [attr.data-testid]="ELTERNSCHAFTSTEILUNG.GEMEINSAM"
                >
                  {{ 'shared.form.familiensituation.gemeinsam' | translate }}
                </mat-option>
              </mat-select>

              <mat-error *dvSharedUiFormMessageError="'required'">
                {{ 'shared.form.error.required' | translate }}
              </mat-error>
            </mat-form-field>
          </div>

          <div class="row g-4 mt-3 col-xl-8">
            <!-- OBHUT AUFTEILUNG -->
            @if (!hiddenFieldsSetSig().has(form.controls.obhutMutter)) {
              <dv-shared-ui-percentage-splitter
                [updateValidity]="updateValidity$ | async"
                [controlA]="form.controls.obhutMutter"
                [controlB]="form.controls.obhutVater"
              >
                <label>{{ 'shared.form.familiensituation.obhutsaufteilung.label' | translate }}</label>
                <span class="label-a">{{ 'shared.form.familiensituation.obhutsaufteilung.mutter' | translate }}</span>
                <span class="label-b">{{ 'shared.form.familiensituation.obhutsaufteilung.vater' | translate }}</span>
              </dv-shared-ui-percentage-splitter>
            }
          </div>
        </div>
      </div>
    </div>
    <!-- buttons -->
    <dv-shared-ui-step-form-buttons [@hideDuringAnimation]="duringAnimation">
      @if (!viewSig().readonly) {
        <button type="submit" class="btn btn-primary" data-testid="button-save-continue">
          {{ 'shared.form.save-and-continue' | translate }}
        </button>
      } @else {
        <button type="button" class="btn btn-primary" data-testid="button-next" (click)="handleContinue()">
          {{ 'shared.form.gonext' | translate }}
        </button>
      }
    </dv-shared-ui-step-form-buttons>

    <ng-template #mutterWiederverheiratet>
      <div class="row g-4 mt-3">
        <mat-radio-group
          formControlName="mutterWiederverheiratet"
          data-testid="form-family-mutterWiederverheiratet"
          dvSharedUiFormField
          class="d-flex flex-column"
        >
          <label>{{ 'shared.form.familiensituation.mutter-wiederverheiratet.label' | translate }}</label>

          <mat-radio-button data-testid="yes" [value]="true">{{
            'shared.form.radio.yes' | translate
          }}</mat-radio-button>

          <mat-radio-button data-testid="no" [value]="false">{{ 'shared.form.radio.no' | translate }}</mat-radio-button>

          <mat-error *dvSharedUiFormMessageError="'required'">
            {{ 'shared.form.error.required' | translate }}
          </mat-error>
        </mat-radio-group>
      </div>
    </ng-template>

    <ng-template #vaterWiederverheiratet>
      <div class="row g-4 mt-3">
        <mat-radio-group
          formControlName="vaterWiederverheiratet"
          data-testid="form-family-vaterWiederverheiratet"
          dvSharedUiFormField
          class="d-flex flex-column"
        >
          <label>{{ 'shared.form.familiensituation.vater-wiederverheiratet.label' | translate }}</label>

          <mat-radio-button data-testid="yes" [value]="true">{{
            'shared.form.radio.yes' | translate
          }}</mat-radio-button>

          <mat-radio-button data-testid="no" [value]="false">{{ 'shared.form.radio.no' | translate }}</mat-radio-button>

          <mat-error *dvSharedUiFormMessageError="'required'">
            {{ 'shared.form.error.required' | translate }}
          </mat-error>
        </mat-radio-group>
      </div>
    </ng-template>
  </form>
}
