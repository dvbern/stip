@let zusammenfassung = berechnungStore.berechnungZusammenfassungViewSig();
@if (berechnungStore.berechnung() | rdIsPendingWithoutCache) {
  <dv-shared-ui-loading></dv-shared-ui-loading>
} @else {
  <ng-container *transloco="let t">
    <mat-card class="rounded-4 mb-4">
      <mat-card-header>
        <mat-card-title>
          <h2 class="d-flex align-items-center mb-0 gap-2">
            <dv-shared-ui-icon-chip>
              <i class="material-symbols-rounded text-info">equal</i>
            </dv-shared-ui-icon-chip>
            {{ t('sachbearbeitung-app.verfuegung.zusammenfassung.resultat.title') }}
          </h2>
        </mat-card-title>
      </mat-card-header>

      <div class="border-bottom mt-4 border-1"></div>

      <mat-card-content class="tw:!flex tw:items-center tw:gap-5 p-5">
        @if (zusammenfassung.berechnung > 0) {
          @if (zusammenfassung.verminderteBerechnung) {
            <div class="accept rounded-4 fs-3 fw-bold tw:flex-1 p-4" data-testid="zusammenfassung-resultat">
              {{ t('sachbearbeitung-app.verfuegung.zusammenfassung.resultat.vermindert') }}
            </div>
          } @else {
            <div class="accept rounded-4 fs-3 fw-bold tw:flex-1 p-4" data-testid="zusammenfassung-resultat">
              {{ t('sachbearbeitung-app.verfuegung.zusammenfassung.resultat.angenommen') }}
            </div>
          }
        } @else {
          <div class="reject rounded-4 fs-3 fw-bold tw:flex-1 p-4" data-testid="zusammenfassung-resultat">
            {{ t('sachbearbeitung-app.verfuegung.zusammenfassung.resultat.abgelehnt') }}
          </div>
        }
        @if (gesuchIdSig(); as id) {
          <button
            type="button"
            class="btn btn-outline-primary fs-7 tw:!p-4 tw:text-sm"
            [dvDownloadButton]="{ type: 'berechnungsblatt', id }"
          >
            <span class="material-symbols-rounded tw:align-middle">download</span>
          </button>
        }
      </mat-card-content>
    </mat-card>

    <!-- zusammenfassung -->
    <mat-card class="rounded-4 mb-4">
      <mat-card-header>
        <mat-card-title>
          @if (zusammenfassung.verminderteBerechnung) {
            <div class="text-muted mb-1">
              {{ t('sachbearbeitung-app.verfuegung.zusammenfassung.verminderteSubtitle') }}
            </div>
          } @else {
            <div class="text-muted mb-1">{{ t('sachbearbeitung-app.verfuegung.zusammenfassung.subtitle') }}</div>
          }
          <h3 class="fs-4 mb-0">
            {{ t('sachbearbeitung-app.verfuegung.zusammenfassung.title') }}
          </h3>
        </mat-card-title>
      </mat-card-header>

      <div class="border-bottom mt-4 mb-4 border-1"></div>

      <mat-card-content class="d-flex flex-column gap-2">
        @for (berechnungen of zusammenfassung.berechnungsresultate; track $index; let berechnungsIndex = $index) {
          @for (teilBerechnung of berechnungen; track $index) {
            <div class="d-flex justify-content-between fs-5">
              <span>
                {{
                  t('sachbearbeitung-app.verfuegung.zusammenfassung.item.total', {
                    index: berechnungsIndex + 1,
                    type: teilBerechnung.type,
                  })
                }}
                {{ t('shared.label.von') }} {{ teilBerechnung.gueltigAb | date: 'MM.yyyy' }}
                {{ t('shared.label.bis') }}
                {{ teilBerechnung.gueltigBis | date: 'MM.yyyy' }}
              </span>
              <div>{{ teilBerechnung.berechnung | formatChf: false }}</div>
            </div>
            <a class="text-decoration-none text-info mb-3" [routerLink]="['../berechnung', berechnungsIndex + 1]">
              <div class="d-flex align-items-center">
                <span class="text-decoration-underline">{{
                  t('sachbearbeitung-app.verfuegung.zusammenfassung.item.link', {
                    index: berechnungsIndex + 1,
                    type: teilBerechnung.type,
                  })
                }}</span>
                <i class="material-symbols-rounded fs-5 text-decoration-none">open_in_new</i>
              </div>
            </a>
          }
        }
      </mat-card-content>

      <div class="border-bottom mt-4 border-1"></div>

      <mat-card-footer class="px-3 py-4">
        @if (zusammenfassung.verminderteBerechnung) {
          <div class="d-flex justify-content-between fs-5 h4">
            <div>
              {{ t('sachbearbeitung-app.verfuegung.zusammenfassung.totalBetragStipendium') }}
            </div>
            <div>
              {{ zusammenfassung.berechnung | formatChf }}
            </div>
          </div>
          <div class="d-flex text-muted justify-content-between fs-5 tw:mb-2">
            <div>
              {{
                t('sachbearbeitung-app.verfuegung.zusammenfassung.verminderungsBetrag', {
                  months: zusammenfassung.verminderteBerechnung.monate,
                })
              }}
            </div>
            <div>
              {{ zusammenfassung.verminderteBerechnung.reduktionsBetrag | formatChfNegative }}
            </div>
          </div>
          <div class="d-flex justify-content-between fs-4 h4">
            <div>
              {{ t('sachbearbeitung-app.verfuegung.zusammenfassung.effektiverBetragStipendium') }}
            </div>
            <div>
              {{ zusammenfassung.verminderteBerechnung.berechnungReduziert | formatChf }}
            </div>
          </div>
        } @else {
          <div class="d-flex justify-content-between fs-4 h4">
            <div>
              {{ t('sachbearbeitung-app.verfuegung.zusammenfassung.totalBetragStipendium') }}
            </div>
            <div>
              {{ zusammenfassung.berechnung | formatChf }}
            </div>
          </div>
        }
      </mat-card-footer>
    </mat-card>
  </ng-container>
}
