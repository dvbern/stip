@if (
  (ausbildungStore.ausbildung() | rdIsPendingWithoutCache: { ignoreInitial: true }) ||
  (ausbildungsstatteStore.ausbildungsstaetten() | rdIsPendingWithoutCache: { ignoreInitial: true })
) {
  <dv-shared-ui-loading></dv-shared-ui-loading>
} @else {
  <form
    [formGroup]="form"
    [dvSharedUiFormReadonly]="!isEditableSig()"
    data-testid="form-education-form"
    novalidate
    class="testing-library-fix tw:mt-6 tw:grid tw:min-w-[425px] tw:grid-cols-1 tw:gap-x-6 tw:gap-y-4 tw:pt-4 tw:md:min-w-[640px] tw:md:grid-cols-2"
    [class.tw:lg:grid-cols-3]="!fallIdSig()"
    (ngSubmit)="handleSave()"
  >
    <h3 class="tw:md:col-span-2 tw:lg:col-span-3">
      {{ 'shared.form.ausbildung.place.title' | transloco }}
    </h3>

    <div class="testing-library-fix tw:flex tw:w-full tw:gap-2">
      @if (!form.value['ausbildungNichtGefunden']) {
        <!-- STAETTE -->
        <div class="testing-library-fix tw:w-full">
          <dv-shared-ui-select-search
            [formControl]="form.controls.ausbildungsstaetteId"
            [testIdSig]="'form-education-ausbildungsstaette'"
            [labelKeySig]="'shared.form.ausbildung.ausbildungsstaette.label'"
            [valuesSig]="ausbildungsstaettenOptionsSig()"
            [languageSig]="languageSig()"
            [invalidValueLabelKeySig]="'shared.form.ausbildung.ausbildungsstaette.error.invalid' | transloco"
          ></dv-shared-ui-select-search>
        </div>
      } @else {
        <!-- Alternative STAETTE -->
        <mat-form-field dvSharedUiFormField class="tw:w-full">
          <mat-label>{{ 'shared.form.ausbildung.ausbildungsstaette.label' | transloco }}</mat-label>
          <input
            matInput
            dvMaxLength
            type="text"
            formControlName="alternativeAusbildungsstaette"
            data-testid="form-education-alternativeAusbildungsstaette"
          />
        </mat-form-field>
      }

      @if (ausbildungsstaettDocumentSig(); as options) {
        <dv-shared-pattern-document-upload [optionsSig]="options"></dv-shared-pattern-document-upload>
      }

      <button
        type="button"
        (click)="ausbildungsstaetteInfoDialog.toggle()"
        class="dv-icon-button dv-icon-button-md text-info mt-2"
        [attr.aria-label]="'shared.form-field.toggle-info-messages' | transloco"
      >
        <span class="material-symbols-rounded"> info </span>
      </button>
    </div>

    <div
      dvSharedUiInfoDialog
      [dialogTitleKey]="'shared.form.ausbildung.ausbildungsstaette.label'"
      [dialogMessageKey]="'shared.form.ausbildung.ausbildungsstaette.info'"
      [forceDialogPosition]="!!fallIdSig()"
      #ausbildungsstaetteInfoDialog="dvSharedUiInfoDialog"
      class="tw:xl:col-start-3"
    ></div>

    <!-- GANG -->
    <div class="testing-library-fix tw:col-start-1 tw:flex tw:w-full tw:gap-2">
      @if (!form.value['ausbildungNichtGefunden']) {
        <div class="testing-library-fix tw:w-full">
          <dv-shared-ui-select-search
            [formControl]="form.controls.ausbildungsgangId"
            [testIdSig]="'form-education-ausbildungsgang'"
            [labelKeySig]="'shared.form.ausbildung.ausbildungsgang.label'"
            [valuesSig]="ausbildungsgangOptionsSig()"
            [languageSig]="languageSig()"
            [invalidValueLabelKeySig]="'shared.form.ausbildung.ausbildungsgang.error.invalid' | transloco"
          ></dv-shared-ui-select-search>
        </div>
      } @else {
        <mat-form-field dvSharedUiFormField class="tw:w-full">
          <mat-label>{{ 'shared.form.ausbildung.ausbildungsgang.label' | transloco }}</mat-label>
          <!-- alternativer Ausbildungsgang -->
          <input
            type="text"
            matInput
            dvMaxLength
            formControlName="alternativeAusbildungsgang"
            data-testid="form-education-alternativeAusbildungsgang"
          />
          <mat-error *dvSharedUiFormMessageError="'required'">
            {{ 'shared.form.error.required' | transloco }}
          </mat-error>
        </mat-form-field>
      }
      <button
        type="button"
        (click)="ausbildungsgangInfoDialog.toggle()"
        class="dv-icon-button dv-icon-button-md text-info mt-2"
        [attr.aria-label]="'shared.form-field.toggle-info-messages' | transloco"
      >
        <span class="material-symbols-rounded"> info </span>
      </button>
    </div>

    <!-- FACHRICHTUNG -->
    <div class="testing-library-fix tw:flex tw:w-full tw:gap-2">
      @if (!hiddenFieldsSetSig().has(form.controls.fachrichtungBerufsbezeichnung) && zusatzfrageSig(); as zusatzfrage) {
        <mat-form-field class="tw:w-full" dvSharedUiFormField>
          <mat-label>{{ 'shared.form.ausbildung.fachrichtung.label.' + zusatzfrage | transloco }}</mat-label>
          <input
            type="text"
            matInput
            dvMaxLength
            formControlName="fachrichtungBerufsbezeichnung"
            data-testid="form-education-fachrichtung"
          />
          <mat-error *dvSharedUiFormMessageError="'required'">
            {{ 'shared.form.error.required' | transloco }}
          </mat-error>
        </mat-form-field>
        <button
          type="button"
          (click)="fachrichtungInfoDialog.toggle()"
          class="dv-icon-button dv-icon-button-md text-info mt-2"
          [attr.aria-label]="'shared.form-field.toggle-info-messages' | transloco"
        >
          <span class="material-symbols-rounded"> info </span>
        </button>
      }
    </div>

    <div class="tw:xl:col-start-3">
      <div
        dvSharedUiInfoDialog
        [dialogTitleKey]="'shared.form.ausbildung.ausbildungsgang.label'"
        [dialogMessageKey]="'shared.form.ausbildung.ausbildungsgang.info'"
        [forceDialogPosition]="!!fallIdSig()"
        #ausbildungsgangInfoDialog="dvSharedUiInfoDialog"
      ></div>
      <div
        dvSharedUiInfoDialog
        [dialogTitleKey]="'shared.form.ausbildung.fachrichtung.label'"
        [dialogMessageKey]="'shared.form.ausbildung.fachrichtung.info'"
        [forceDialogPosition]="!!fallIdSig()"
        #fachrichtungInfoDialog="dvSharedUiInfoDialog"
      ></div>
    </div>

    <!-- besuchtBMS -->
    @if (showBesuchtBMS()) {
      <mat-checkbox
        class="tw:col-span-2 tw:col-start-1 tw:mb-6"
        formControlName="besuchtBMS"
        data-testid="form-education-besuchtBMS"
        >{{ 'shared.form.ausbildung.besuchtBMS.label' | transloco }}</mat-checkbox
      >
    }

    <div class="testing-library-fix tw:col-start-1">
      @if (form.controls.isAusbildungAusland.value) {
        <!-- Land -->
        <dv-shared-ui-select-search
          formControlName="landId"
          [testIdSig]="'form-education-land'"
          [labelKeySig]="'shared.form.shared.address.country.label'"
          [valuesSig]="laenderSig()"
          [languageSig]="languageSig()"
          [firstItemSig]="{ propName: 'iso3code', value: 'CHE' }"
          [panelWidthSig]="'auto'"
          [invalidValueLabelKeySig]="'shared.form.error.land.invalidLand'"
        ></dv-shared-ui-select-search>
      } @else {
        <div
          class="tw:flex tw:gap-2"
          dvPlzOrtAutocomplete
          [autocompleteSig]="plzAutocomplete"
          [plzFormSig]="form.controls.ausbildungsortPlzOrt"
          (plzLookupValuesSig)="plzValues = $event"
        >
          <!-- PLZ -->
          <mat-form-field dvSharedUiFormField class="tw:max-w-26">
            <mat-label>{{ 'shared.form.shared.address.zipcode.label' | transloco }}</mat-label>
            <input
              type="text"
              matInput
              [dvMaxLength]="'small'"
              [formControl]="form.controls.ausbildungsortPlzOrt.controls.plz"
              [matAutocomplete]="plzAutocomplete"
              data-testid="form-education-ausbildungs-plz"
            />
            <mat-error *dvSharedUiFormMessageError="'required'">
              {{ 'shared.form.error.requiredShort' | transloco }}
            </mat-error>
            <mat-autocomplete #plzAutocomplete="matAutocomplete" [panelWidth]="'320px'">
              @for (lookup of plzValues; track $index) {
                <mat-option [value]="lookup" [attr.data-testid]="'plz-' + lookup.plz">
                  {{ lookup.plz }} {{ lookup.ort }}
                </mat-option>
              }
            </mat-autocomplete>
          </mat-form-field>

          <!-- Ort -->
          <mat-form-field dvSharedUiFormField class="tw:basis-11/12">
            <mat-label>{{ 'shared.form.ausbildung.ausbildungsort.label' | transloco }}</mat-label>
            <input
              type="text"
              matInput
              dvMaxLength
              [formControl]="form.controls.ausbildungsortPlzOrt.controls.ort"
              data-testid="form-education-ausbildungs-ort"
            />
            <mat-error *dvSharedUiFormMessageError="'required'">
              {{ 'shared.form.error.required' | transloco }}
            </mat-error>
          </mat-form-field>
        </div>
      }
    </div>

    <!-- isAusbildungAusland -->
    <mat-checkbox formControlName="isAusbildungAusland" data-testid="form-education-isAusbildungAusland">{{
      'shared.form.ausbildung.isAusbildungAusland.label' | transloco
    }}</mat-checkbox>

    <div
      class="testing-library-fix tw:col-start-1 tw:flex tw:w-full tw:flex-col tw:gap-2 tw:md:col-span-2 tw:lg:col-span-3"
    >
      <!-- MANUELL -->
      <mat-checkbox
        formControlName="ausbildungNichtGefunden"
        data-testid="form-education-ausbildungNichtGefunden"
        (change)="handleManuellChangedByUser()"
        >{{ 'shared.form.ausbildung.manuell.label' | transloco }}</mat-checkbox
      >
      <div class="group-errors">
        @if (form.controls.ausbildungNichtGefunden.errors?.['requiredOff']) {
          <mat-error>
            {{ 'shared.form.ausbildung.validation.notFound.part1' | transloco }}
            <a [routerLink]="['/administration/ausbildungsstaette']">{{
              'shared.form.ausbildung.validation.notFound.link' | transloco
            }}</a>
            {{ 'shared.form.ausbildung.validation.notFound.part2' | transloco }}
          </mat-error>
        }
      </div>
    </div>

    <h3 class="tw:!mt-6 tw:md:col-span-2 tw:lg:col-span-3">
      {{ 'shared.form.ausbildung.duration.title' | transloco }}
    </h3>

    <!-- START -->
    <mat-form-field dvSharedUiFormField>
      <mat-label>{{ 'shared.form.ausbildung.start.label' | transloco }}</mat-label>

      <input
        matInput
        [dvMaxLength]="'small'"
        data-testid="form-education-beginn-der-ausbildung"
        formControlName="ausbildungBegin"
        placeholder="MM.yyyy"
        (change)="markDatesAsTouched()"
        (blur)="onDateBlur(form.controls.ausbildungBegin)"
      />

      <mat-error *dvSharedUiFormMessageError="'required'">
        {{ 'shared.form.error.required' | transloco }}
      </mat-error>
      <mat-error *dvSharedUiFormMessageError="'dateFormat'">
        {{ 'shared.form.error.dateFormat' | transloco }}
      </mat-error>
      <mat-error *dvSharedUiFormMessageError="'maxDate'">
        {{ 'shared.form.error.maxDateFuture' | transloco }}
      </mat-error>
      <mat-error *dvSharedUiFormMessageError="'endDateAfterStart'">
        {{ 'shared.form.ausbildung.form.error.monthYearAfterStart' | transloco }}
      </mat-error>
      <mat-error *dvSharedUiFormMessageError="'minDateLebenslauf'">
        {{ 'shared.form.ausbildung.form.error.lebenslaufConflict' | transloco }}
      </mat-error>

      <!-- api errors -->
      <mat-error *dvSharedUiFormMessageError="'periodeNotFound'">
        {{ 'shared.form.ausbildung.form.error.periodeNotFound' | transloco }}
      </mat-error>
      <mat-error *dvSharedUiFormMessageError="'inactivePeriod'">
        {{
          'shared.form.ausbildung.form.error.inactivePeriod'
            | transloco
              : { date: (ausbildungStore.ausbildungCreateErrorResponseViewSig()?.context | date: 'dd.MM.yyyy') }
        }}
      </mat-error>
      <mat-error *dvSharedUiFormMessageError="'periodeIsDraft'">
        {{
          'shared.form.ausbildung.form.error.periodeIsDraft'
            | transloco
              : { date: (ausbildungStore.ausbildungCreateErrorResponseViewSig()?.context | date: 'dd.MM.yyyy') }
        }}
      </mat-error>
    </mat-form-field>

    <!-- ENDE -->
    <mat-form-field dvSharedUiFormField>
      <mat-label>{{ 'shared.form.ausbildung.ende.label' | transloco }}</mat-label>

      <input
        matInput
        [dvMaxLength]="'small'"
        data-testid="form-education-ende-der-ausbildung"
        formControlName="ausbildungEnd"
        placeholder="MM.yyyy"
        (change)="markDatesAsTouched()"
        (blur)="onDateBlur(form.controls.ausbildungEnd)"
      />
      <mat-error *dvSharedUiFormMessageError="'required'">
        {{ 'shared.form.error.required' | transloco }}
      </mat-error>
      <mat-error *dvSharedUiFormMessageError="'dateFormat'">
        {{ 'shared.form.error.dateFormat' | transloco }}
      </mat-error>
      <mat-error *dvSharedUiFormMessageError="'minDate'">
        {{
          'shared.form.ausbildung.form.error.monthYearAfter'
            | transloco: { date: ausbildungStore.ausbildungViewSig().minEndDatumFormatted }
        }}
      </mat-error>
      <mat-error *dvSharedUiFormMessageError="'endDateAfterStart'">
        {{ 'shared.form.ausbildung.form.error.monthYearAfterStart' | transloco }}
      </mat-error>
      <mat-error *dvSharedUiFormMessageError="'maxDate'">
        {{ 'shared.form.error.maxDateFuture' | transloco }}
      </mat-error>
    </mat-form-field>

    <!-- PENSUM -->
    <mat-form-field dvSharedUiFormField class="tw:col-start-1 tw:mt-9">
      <mat-label>{{ 'shared.form.ausbildung.pensum.label' | transloco }}</mat-label>

      <mat-select
        formControlName="pensum"
        data-testid="form-education-pensum"
        [placeholder]="'shared.form.select.empty' | transloco"
      >
        @for (l of ausbildungspensumValues; track $index) {
          <mat-option [value]="l" [attr.data-testid]="l">
            {{ 'shared.form.ausbildung.pensum.' + l | transloco }}
          </mat-option>
        }
      </mat-select>

      <mat-error *dvSharedUiFormMessageError="'required'">
        {{ 'shared.form.error.required' | transloco }}
      </mat-error>
    </mat-form-field>

    @if (isEditableSig()) {
      <div class="tw:md:col-span-2 tw:lg:col-span-3">
        <button
          type="submit"
          class="btn btn-primary"
          data-testid="button-save"
          [disabled]="form.invalid || (ausbildungStore.ausbildung() | rdIsPending: { ignoreInitial: true })"
        >
          {{ 'shared.form.save' | transloco }}
        </button>
      </div>
    }
  </form>
}
