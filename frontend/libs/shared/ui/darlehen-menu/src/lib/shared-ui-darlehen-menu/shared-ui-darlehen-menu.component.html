@let darlehens = darlehenListByStatusSig();
@let fallId = fallIdSig();
<button
  type="button"
  class="btn btn-nav fw-normal d-flex align-items-center px-2 shadow-none"
  data-testid="header-nav-darlehen-menu"
  [matMenuTriggerFor]="darlehenMenu"
  [disabled]="!darlehenListSig()?.darlehenList?.length && gesuchIdSig()"
  [class.active]="darlehenRouteIdSig()"
>
  <i class="material-symbols-rounded me-2 text-white">account_balance</i>
  <span>{{ 'shared.header.darlehen' | transloco }}</span>
  <i class="material-symbols-rounded ms-2">expand_more</i>
</button>

<mat-menu #darlehenMenu="matMenu" class="header-menu-panel mt-2 rounded">
  <div class="d-flex flex-column gap-2">
    @for (state of darlehenCompletedStates; track $index) {
      @if (darlehens[state] && darlehens[state].length) {
        <div class="d-flex align-items-center text-muted small gap-2">
          <hr class="flex-grow-1" />
          {{ 'shared.header.darlehen.complete-states.' + state | transloco }}
          <hr class="flex-grow-1" />
        </div>
        @for (darlehen of darlehens[state]; track $index) {
          <a
            [routerLink]="
              gesuchIdSig()
                ? ['/', 'darlehen', darlehen.id, 'gesuch', gesuchIdSig()]
                : ['/', 'darlehen', darlehen.id, 'fall', fallId]
            "
            class="btn btn-nav fw-normal d-flex align-items-center px-3 shadow-none"
            data-testid="header-nav-darlehen-menu-item"
            [class.active]="darlehenRouteIdSig() === darlehen.id"
            mat-menu-item
          >
            <span>
              {{
                'shared.header.darlehen.item'
                  | transloco
                    : {
                        date: darlehen.timestampErstellt | date: 'dd.MM.yyyy',
                      }
              }}
            </span>
          </a>
        }
      }
    }

    @if (fallId && canCreateDarlehenSig()) {
      <hr class="flex-grow-1 tw:hidden tw:not-first:block" />
      <button
        type="button"
        class="btn tw:font-normal tw:shadow-none!"
        data-testid="cockpit-gesuch-darlehen-create"
        (click)="createDarlehen.emit({ fallId })"
        mat-menu-item
      >
        <div class="tw:flex tw:items-center tw:gap-2">
          <i class="material-symbols-rounded">add_circle</i>
          {{ 'shared.dashboard.darlehen.create' | transloco }}
        </div>
      </button>
    }
  </div>
</mat-menu>
