@let gesuch = gesuchSig();
@let periode = gesuch.gesuchsperiode;
<div class="tw:relative tw:@container">
  <div class="tw:absolute tw:right-0 tw:top-0 tw:font-bold">
    {{
      (gesuch.isErstgesuch ? 'shared.dashboard.gesuch.order.erstgesuch' : 'shared.dashboard.gesuch.order.folgegesuch')
        | transloco
    }}
  </div>
  <div
    class="tw:grid tw:gap-4"
    [ngClass]="{ 'tw:grid-cols-[1fr] tw:@lg:grid-cols-[1fr_auto_1fr]': gesuch.offeneAenderung }"
  >
    <div class="tw:flex tw:flex-col">
      <dl class="tw:flex tw:flex-col" [class.tw:!mb-0]="!gesuch.isActive" [class.tw:!mb-10]="gesuch.isActive">
        <dt class="tw:font-bold">
          {{ 'shared.dashboard.gesuch.title' | transloco: { yearRange: gesuch.yearRange } }}
        </dt>
        <dd class="tw:!mb-6">
          {{ periode.gesuchsperiodeStart | date: 'MM.yyyy' }} - {{ periode.gesuchsperiodeStopp | date: 'MM.yyyy' }}
        </dd>

        @let missingDocTrancheId = gesuch.missingDocuments?.trancheId;
        @if (gesuch.isActive) {
          <dt class="tw:font-bold">{{ 'shared.dashboard.gesuch.status.title' | transloco }}</dt>
          <dd class="tw:!mb-6">
            @if (gesuch.gesuchStatus !== 'IN_BEARBEITUNG_GS' && gesuch.missingDocuments?.count; as count) {
              @if (count > 1) {
                {{ 'shared.dashboard.gesuch.status.missingDocuments' | transloco: { count } }}
              } @else {
                {{ 'shared.dashboard.gesuch.status.missingDocument' | transloco }}
              }
            } @else {
              {{ 'gesuch-app.gesuch.status.contract.' + gesuch.gesuchStatus | transloco }}
            }
          </dd>

          @if (!gesuch.einreichefristAbgelaufen) {
            @if (gesuch.reduzierterBeitrag) {
              <span class="tw:font-bold">
                {{ 'shared.dashboard.periode.einreichefrist.reduziert' | transloco }}
              </span>
            }
            @if ((gesuch.einreichefristDays ?? 0) > 1) {
              <span
                [innerHTML]="
                  'shared.dashboard.periode.einreichefrist.remaining' + (gesuch.reduzierterBeitrag ? '.reduziert' : '')
                    | transloco: { days: gesuch.einreichefristDays }
                "
              ></span>
            } @else if (gesuch.einreichefristDays === 1) {
              <span
                [innerHTML]="
                  'shared.dashboard.periode.einreichefrist.1remaining' + (gesuch.reduzierterBeitrag ? '.reduziert' : '')
                    | transloco
                "
              ></span>
            } @else {
              <span
                [innerHTML]="
                  'shared.dashboard.periode.einreichefrist.0remaining' + (gesuch.reduzierterBeitrag ? '.reduziert' : '')
                    | transloco
                "
              ></span>
            }
            <dt class="tw:mt-6 tw:font-bold">
              {{ 'shared.dashboard.periode.einreichefrist.text' | transloco }}
            </dt>
            <dd>
              {{
                (gesuch.reduzierterBeitrag ? periode.einreichefristReduziert : periode.einreichefristNormal)
                  | date: 'dd.MM.yyyy'
              }}
            </dd>
          } @else {
            <span class="tw:font-bold">
              {{ 'shared.dashboard.periode.einreichefrist.abgelaufen.warning' | transloco }}
            </span>
            <span class="tw:mt-6">{{ 'shared.dashboard.periode.einreichefrist.abgelaufen.text' | transloco }}</span>
          }
          @if (missingDocTrancheId && gesuch.nachfristDokumente) {
            <dt class="tw:mt-6 tw:font-bold">
              {{ 'shared.dashboard.periode.nachfrist.text' | transloco }}
            </dt>
            <dd>
              {{ gesuch.nachfristDokumente | date: 'dd.MM.yyyy' }}
            </dd>
          }
        }
      </dl>
      <div class="tw:grow"></div>
      <div
        class="tw:gap-3"
        [ngClass]="{
          'tw:flex tw:flex-col-reverse': gesuch.offeneAenderung,
          'tw:grid tw:grid-cols-2 tw:xl:grid-cols-3': !gesuch.offeneAenderung,
        }"
      >
        @if (gesuch.id) {
          @if (gesuch.isActive) {
            @if (gesuch.canEdit) {
              <a
                class="btn btn-primary"
                data-testid="cockpit-gesuch-edit"
                [routerLink]="['/gesuch', gesuch.id, 'tranche', gesuch.currentTrancheId]"
              >
                {{ 'shared.dashboard.gesuch.edit' | transloco }}
              </a>

              @if (gesuch.canDelete) {
                <button
                  type="button"
                  class="btn btn-outline-primary"
                  data-testid="shared.dashboard.gesuch.delete"
                  (click)="deleteGesuch.emit(gesuch.id)"
                >
                  <span>{{ 'shared.dashboard.gesuch.delete' | transloco }}</span>
                </button>
              }
            } @else if (gesuch.gesuchStatus === 'IN_BEARBEITUNG_GS') {
              <a
                class="btn btn-primary"
                data-testid="cockpit-gesuch-edit"
                [routerLink]="['/gesuch', gesuch.id, 'tranche', gesuch.currentTrancheId]"
              >
                {{ 'shared.dashboard.gesuch.open' | transloco }}
              </a>
            } @else if (missingDocTrancheId) {
              <a
                class="btn btn-primary"
                data-testid="cockpit-gesuch-upload-missing-documents"
                [routerLink]="['/gesuch', 'dokumente', gesuch.id, 'tranche', missingDocTrancheId]"
              >
                {{ 'shared.dashboard.gesuch.uploadMissingDocuments' | transloco }}
              </a>
            }
          }
          @if (!gesuch.isActive || gesuch.gesuchStatus !== 'IN_BEARBEITUNG_GS') {
            <a
              class="btn btn-outline-primary"
              data-testid="cockpit-gesuch-edit"
              [routerLink]="['/gesuch', gesuch.id, 'tranche', gesuch.currentTrancheId]"
            >
              {{ 'shared.dashboard.gesuch.open' | transloco }}
            </a>

            @if (gesuch.canCreateAenderung) {
              <button
                type="button"
                class="btn btn-outline-primary"
                data-testid="cockpit-gesuch-aenderung-create"
                (click)="aenderungMelden.emit()"
              >
                {{ 'shared.dashboard.aenderung.create' | transloco }}
              </button>
            }
          }
          <!-- todo: add conditions -->
          <a class="btn btn-outline-primary" data-testid="cockpit-gesuch-edit" [routerLink]="['/darlehen', gesuch.id]">
            {{ 'shared.dashboard.darlehen.create' | transloco }}
          </a>
        }
      </div>
    </div>
    @if (gesuch.offeneAenderung) {
      <!-- Vertical Line -->
      <div class="tw:h-full tw:min-h-[3px] tw:w-full tw:min-w-[3px] tw:bg-(--dv-light-border-subtle)"></div>
      <div class="tw:flex tw:flex-col">
        @if (gesuch.offeneAenderung; as aenderung) {
          <div class="divider me-4"></div>
          <dv-shared-ui-aenderungs-entry
            class="tw:flex tw:flex-1 tw:flex-col"
            [gesuch]="gesuch"
            [tranche]="aenderung"
            (deleteAenderung)="deleteAenderung.emit($event)"
          ></dv-shared-ui-aenderungs-entry>
        }
      </div>
    }
  </div>
</div>
